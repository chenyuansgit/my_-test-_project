<!DOCTYPE html>
<html lang="en">
<head>
    <%include ../common/head.ejs%>
</head>
<body>
<%include ../common/header.ejs%>
<div class="main-container" id="main-container">
    <script type="text/javascript">
        try{ace.settings.check('main-container' , 'fixed')}catch(e){}
    </script>
    <div class="main-container-inner">
        <a class="menu-toggler" id="menu-toggler" href="#">
            <span class="menu-text"></span>
        </a>
        <%include ../common/sidebar.ejs%>
        <div class="main-content">
            <div class="page-content">
                <div class="row">
                    <div class="col-xs-12">
                        <!-- PAGE CONTENT BEGINS -->
                        <div id="modal-shield" class="modal">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header blue" data-target="#modal-step-contents">屏蔽操作</div>
                                    <div class="modal-body step-content" id="modal-step-contents">
                                        <p class="ib-shield"> 你想要将此职位屏蔽多久</p>
                                        <p>  <input type="text" name="datetime-start" class="ui_timepicker" value="" placeholder="开始时间"> <input type="text" name="datetime-end" class="ui_timepicker" value="" placeholder="结束时间"></p>
                                    </div>
                                    <div class="modal-footer wizard-actions">
                                        <button class="btn btn-success btn-sm btn-next" data-last="Finish ">确定<i class="icon-arrow-right icon-on-right"></i></button>
                                        <button class="btn btn-danger btn-sm pull-left" data-dismiss="modal"><i class="icon-remove"></i>取消</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="modal-delete" class="modal">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header blue" data-target="#modal-step-contents">删除职位</div>
                                    <div class="modal-body step-content">
                                        <p>该职位违反了实习鸟平台规则，现将其删除.若删除错误，可通过已删除栏目找回</p>
                                    </div>
                                    <div class="modal-footer wizard-actions">
                                        <button class="btn btn-success btn-sm btn-next button-delete" data-dismiss="modal">确定<i class="icon-arrow-right icon-on-right"></i></button>
                                        <button class="btn btn-danger btn-sm pull-left" data-dismiss="modal"><i class="icon-remove"></i>取消</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="modal-recover" class="modal">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header blue" data-target="#modal-step-contents">恢复操作</div>
                                    <div class="modal-body step-content">恢复操作之后，职位和账号将恢复正常显示</div>
                                    <div class="modal-footer wizard-actions">
                                        <button class="btn btn-success btn-sm btn-next button-recover" data-last="Finish ">确定<i class="icon-arrow-right icon-on-right"></i></button>
                                        <button class="btn btn-danger btn-sm pull-left" data-dismiss="modal"><i class="icon-remove"></i>取消</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="modal-offline" class="modal">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header blue" data-target="#modal-step-contents">职位下线</div>
                                    <div class="modal-body step-content"><p>下线后可通过“已下线”栏目重新上线。是否确定下线此职位？</p></div>
                                    <div class="modal-footer wizard-actions">
                                        <button class="btn btn-success btn-sm btn-next button-offline" data-dismiss="modal">确定<i class="icon-arrow-right icon-on-right"></i></button>
                                        <button class="btn btn-danger btn-sm pull-left" data-dismiss="modal"><i class="icon-remove"></i>取消</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="modal-online" class="modal">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header blue" data-target="#modal-step-contents">职位上线</div>
                                    <div class="modal-body step-content"><p>是否要将此职位重新上线,如果当前的截止时间大于现在,将不修改职位截止时间,如果小于现在,将截止时间自动到下一个月的今天？</p></div>
                                    <div class="modal-footer wizard-actions">
                                        <button class="btn btn-success btn-sm btn-next button-online" data-dismiss="modal">确定<i class="icon-arrow-right icon-on-right"></i></button>
                                        <button class="btn btn-danger btn-sm pull-left" data-dismiss="modal"><i class="icon-remove"></i>取消</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="modal-recommend" class="modal">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header blue" data-target="#modal-step-contents">推荐操作</div>
                                    <div class="modal-body step-content">
                                        <p>是否要推荐此职位？</p>
                                    </div>
                                    <div class="modal-footer wizard-actions">
                                        <button class="btn btn-success btn-sm btn-next button-recommend" data-dismiss="modal">确定<i class="icon-arrow-right icon-on-right"></i></button>
                                        <button class="btn btn-danger btn-sm pull-left" data-dismiss="modal"><i class="icon-remove"></i>取消</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="modal-unrecommend" class="modal">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header blue" data-target="#modal-step-contents">取消推荐操作</div>
                                    <div class="modal-body step-content">
                                        <p>是否要取消推荐此职位？</p>
                                    </div>
                                    <div class="modal-footer wizard-actions">
                                        <button class="btn btn-success btn-sm btn-next button-unrecommend" data-dismiss="modal">确定<i class="icon-arrow-right icon-on-right"></i></button>
                                        <button class="btn btn-danger btn-sm pull-left" data-dismiss="modal"><i class="icon-remove"></i>取消</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="modal-refresh" class="modal">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header blue" data-target="#modal-step-contents">职位刷新操作</div>
                                    <div class="modal-body step-content">
                                        <p>是否要刷新此职位？</p>
                                    </div>
                                    <div class="modal-footer wizard-actions">
                                        <button class="btn btn-success btn-sm btn-next button-refresh" data-dismiss="modal">确定<i class="icon-arrow-right icon-on-right"></i></button>
                                        <button class="btn btn-danger btn-sm pull-left" data-dismiss="modal"><i class="icon-remove"></i>取消</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-xs-12">
                                <div class="header smaller lighter blue head-title">职位管理
                                    <p class="search-head">
                                        <input type="text" id="search" placeholder="<%if(recommend_id == -1){%><%=option.k%><%}else{%>请输入搜索关键词<%}%>"/> <a href="" class="btn button-search">搜索</a>
                                    </p>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="tabbable">
                                            <ul class="nav nav-tabs" id="myTab">
                                                <li <%if(status == 1 && !recommend_id || recommend_id==-1){%> class="active<%}%>">
                                                    <a href="/job/list?status=1&page=1&&lt=<%=lt%>">
                                                        正常职位 <span class="red"><%if(status == 1 && !recommend_id){%>(<%=(count)%>)<%}%></span>
                                                    </a>
                                                </li>
                                                <li <%if(status == 2 && !recommend_id){%> class="active<%}%>">
                                                    <a  id="tabOffline" href="/job/list?status=2&page=1&lt=<%=lt%>">
                                                        已下线 <span class="red"><%if(status == 2 && !recommend_id){%>(<%=(count)%>)<%}%></span>
                                                    </a>
                                                </li>
                                                <li <%if(status == 9 && !recommend_id){%> class="active<%}%>">
                                                    <a id="tabDelete" href="/job/list?status=9&page=1&lt=<%=lt%>">
                                                        已删除 <span class="red"><%if(status == 9 && !recommend_id){%>(<%=(count)%>)<%}%></span>
                                                    </a>
                                                </li>
                                                <li <%if(recommend_id && recommend_id != -1){%> class="dropdown active<%}%>">
                                                    <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                                                        <%if(parseInt(status) == 1 && parseInt(recommend_id) == 1 ){%>
                                                        <span>精品推荐 <span class="red"><%if(status == 1 && recommend_id){%>(<%=(count)%>)<%}%></span></span> &nbsp;
                                                        <%}else if(parseInt(status) == 1 && parseInt(recommend_id) == 2){%>
                                                        <span>海外实习推荐</span> &nbsp;
                                                        <%}else if(parseInt(status) == 1 && parseInt(recommend_id) == 3){%>
                                                        <span>名企实习推荐</span> &nbsp;
                                                        <%}else if(parseInt(status) == 1 && parseInt(recommend_id) == 4){%>
                                                        <span>初创企业实习推荐</span> &nbsp;
                                                        <%}else{%>
                                                        <span id="recommendTopic">推荐</span> &nbsp;
                                                        <%}%>
                                                        <i class="icon-caret-down bigger-110 width-auto"></i>
                                                    </a>

                                                    <ul class="dropdown-menu dropdown-info recommendList">
                                                        <li>
                                                            <a href="/job/list?status=1&page=1&lt=<%=lt%>&recommend_id=1">精品推荐</a>
                                                        </li>
                                                        <li>
                                                            <a href="/job/list?status=1&page=1&lt=<%=lt%>&recommend_id=2">海外实习</a>
                                                        </li>
                                                        <li>
                                                            <a href="/job/list?status=1&page=1&lt=<%=lt%>&recommend_id=3">名企实习</a>
                                                        </li>
                                                        <li>
                                                            <a href="/job/list?status=1&page=1&lt=<%=lt%>&recommend_id=4">初创企业实习</a>
                                                        </li>
                                                    </ul>
                                                </li>
                                                &nbsp;排序：<input type="radio" class="refresh" name="refresh" id="" value="time">更新时间 &nbsp;
                                                <input type="radio" class="refresh" name="refresh" id="" value="resumes">投递数&nbsp;
                                                <input type="radio" class="refresh" name="refresh" id="" value="views">浏览数
                                                <button id="button-refresh">确定</button>
                                            </ul>
                                            <div class="tab-content">
                                                <div id="home" class="tab-pane in active">
                                                    <table id="sample-table-home" class="table table-striped table-bordered table-hover">
                                                        <thead>

                                                        <tr>
                                                            <th>ID</th>
                                                            <th>职位名称</th>
                                                            <th>职位信息</th>
                                                            <th>统计</th>
                                                            <th>操作</th>
                                                        </tr>
                                                        </thead>
                                                        <%if(jobs.length>0){%>
                                                        <tbody>
                                                        <%for(var i= 0; i<jobs.length; i++)
                                                        {%>
                                                        <tr data-jid="<%=jobs[i].jid%>" data-deadline = "<%=jobs[i].deadline%>">
                                                            <td>
                                                               <%=jobs[i].jid%>
                                                            </td>
                                                            <td>
                                                                <%if(env==='local'){%>
                                                                <a target="_blank" href="http://www.dev.internbird.com/job/detail/<%=jobs[i].jid%>"><span class="ib-operation "><%=jobs[i].name%></span></a>
                                                                <%}else if(env==='development'){%>
                                                                <a target="_blank" href="http://www.dev.internbird.com/job/detail/<%=jobs[i].jid%>"><span class="ib-operation "><%=jobs[i].name%></span></a>
                                                                <%}else{%>
                                                                <a target="_blank" href="http://m.internbird.com/job/detail/<%=jobs[i].jid%>"><span class="ib-operation "><%=jobs[i].name%></span></a>
                                                                <%}%>
                                                                <%if(env==='local'){%>
                                                                <a target="_blank" href="http://www.dev.internbird.com/company/detail/<%=jobs[i].cid%>"><p class="ib-operation "><%=jobs[i].company_name%></p></a>
                                                                <%}else if(env==='development'){%>
                                                                <a target="_blank" href="http://www.dev.internbird.com/company/detail/<%=jobs[i].cid%>"><p class="ib-operation "><%=jobs[i].company_name%></p></a>
                                                                <%}else{%>
                                                                <a target="_blank" href="http://m.internbird.com/company/detail/<%=jobs[i].cid%>"><p class="ib-operation "><%=jobs[i].company_name%></p></a>
                                                                <%}%>
                                                            </td>
                                                            <td>
                                                                <p>发布时间:<%=new Date(jobs[i].create_time).format("yyyy-MM-dd")%></p>
                                                                <p>截止时间:<%=new Date(jobs[i].deadline).format("yyyy-MM-dd")%></p>
                                                                <p>刷新时间:<%=new Date(jobs[i].refresh_time).format("yyyy-MM-dd")%></p>
                                                               <!-- <p>举报次数:111 </p>-->
                                                            </td>
                                                            <td>
                                                                <%if(recommend_id == -1 || jobs[i].view_num == null){%>
                                                                <p>点击：<a href="#" class="ib-operation">--</a></p>
                                                                <p>投递简历数：<a href="#" class="ib-operation">--</a></p>
                                                                <%}else{%>
                                                                <p>点击：<a href="#" class="ib-operation"><%=jobs[i].view_num%></a></p>
                                                                <p>投递简历数：<a href="#" class="ib-operation"><%=jobs[i].resume_num%></a></p>
                                                                <%}%>
                                                            </td>

                                                            <td class="operation">
                                                                <%if(parseInt(status) == 1 && !recommend_id || parseInt(status) == 1 && recommend_id == -1){%>
                                                                <p>
                                                                    <!--<a href="#modal-offline" data-toggle="modal"><span class="ib-operation">下线</span> </a>
                                                                    <a href="#modal-delete" data-toggle="modal"><span class="ib-operation">删除</span> </a>-->
                                                                    <a href="#modal-recommend" data-toggle="modal"><span class="ib-operation">推荐</span> </a>
                                                                    <%var timestamp = (new Date()).valueOf();
                                                                    if(timestamp - jobs[i].refresh_time < 86400000){
                                                                    %>
                                                                    <span>已刷新</span>
                                                                    <%}else{%>
                                                                    <a href="#modal-refresh" data-toggle="modal"><span class="ib-operation">职位刷新</span> </a>
                                                                    <%}%>
                                                                    <%if(jobs[i].recommend_id){%>
                                                                    <span class="recommend-flag"></span>
                                                                    <%}%>
                                                                    <a href="#modal-offline" data-toggle="modal"><span class="ib-operation">职位下线</span> </a>
                                                                </p>
                                                                <%}else if(parseInt(status) == 9){%>

                                                                <p>
                                                                    <a href="#modal-recover" data-toggle="modal"><span class="ib-operation">恢复</span> </a>
                                                                </p>
                                                                <%}else if(parseInt(status) == 2){%>
                                                                <p>
                                                                    <a href="#modal-online" data-toggle="modal"><span class="ib-operation">上线</span> </a>
                                                                </p>
                                                                <%}else{%>
                                                                <p>
                                                                    <a href="#modal-unrecommend" data-toggle="modal"><span class="ib-operation">取消推荐</span> </a>
                                                                </p>
                                                                <%}%>
                                                            </td>
                                                        </tr>
                                                        <%}%>
                                                        </tbody>
                                                        <%}else{%>
                                                        <p>该栏目下没有数据！</p>
                                                        <%}%>
                                                    </table>
                                                    <%include ../common/pages.ejs%>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <a href="#" id="btn-scroll-up" class="btn-scroll-up btn btn-sm btn-inverse">
                        <i class="icon-double-angle-up icon-only bigger-110"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<%include ../common/footer.ejs%>
<script src="/public/ace/assets/js/common/fn.js"></script>
<script>
    window.global = window.global || {};
    global.page = parseInt('<%= page %>') || 1;
    global.recommend_id = parseInt("<%=recommend_id%>");
    global.status = parseInt('<%=status%>');
</script>
<script type="text/javascript">
    var url = location.href;
    var status = global.status;
    var recommend_id = global.recommend_id;
    var page = global.page;
    var key = fn.getUrlPara('k');//获取参数k
    //时间戳格式转换
    Date.prototype.format = function(format) {
        var o = {
            "M+": this.getMonth() + 1,
            "d+": this.getDate(),
            "h+": this.getHours(),
            "m+": this.getMinutes(),
            "s+": this.getSeconds(),
            "q+": Math.floor((this.getMonth() + 3) / 3),
            "S": this.getMilliseconds()
        };
        if (/(y+)/.test(format)) {
            format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        }
        for (var k in o) {
            if (new RegExp("(" + k + ")").test(format)) {
                format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
            }
        }
        return format;
    };
    //给sidebar加样式
    if(url.indexOf('job')){
        $('#recruitMenu').addClass('active open');
        $('#recruitMenu ul li:eq(1)').addClass('active')
    }
    //分页绑定
    fn.pagingBind();
    //职位搜索
    $('.button-search').click(function(){
        var searchText = $('#search').val();
        url = "/job/list?"
        url= url + "k=" + searchText +'&page=1';
        location.href = url;
        return false;
    })

    //排序关键词选择
    var lt = fn.getUrlPara("lt");
    var $sort = $(".refresh");
        if(lt == 'resumes'){
            $sort.eq(1).attr('checked','checked');
        }
        else if(lt == 'views'){
            $sort.eq(2).attr('checked','checked');
        }
        else {
            $sort.eq(0).attr('checked','checked');
        }


    $('#button-refresh').click(function(){
        var $sort = $(".refresh");
        for(var i=0; i<$sort.length; i++)
        {
            if($sort.eq(i).is(':checked') == true){
                location.href = url.replace('lt=' + lt,'lt='+ $sort.eq(i).val()) ;
                break;
            }
        }
    })
    $('.ib-operation').on('click',function(){
        $('.ib-operation.active').removeClass('active');
        $(this).addClass('active');
    });
    //操作
        $('.button-delete').click(function(){
            var jid = $('.ib-operation.active').closest('tr').attr('data-jid');
            url = '/job/del/' + jid;
            $.ajax({
                type:'POST',
                url:url,
                dataType:'json',
                data:{
                },
                success:function(data){
                    if(data.status == '10000'){
                        //alert('POST success');
                        location.reload();
                    }
                    else{
                        alert('POST error\n' + data.status);
                    }

                }
            });
        })
        //恢复，暂无接口
        $('.button-recover').click(function(){
            var jid = $('.ib-operation.active').closest('tr').attr('data-jid');
            $.ajax({
                type:'POST',
                url:'/job/recover/'+jid,
                dataType:'json',
                data:{
                },
                success:function(data){
                    if(data.status == '10000'){
                        //alert('POST success');
                        location.reload();
                    }
                    else{
                        alert('POST error\n' + data.status);
                    }

                }
            });
        })
        $('.button-offline').click(function(){
            var jid = $('.ib-operation.active').closest('tr').attr('data-jid');
            url = "/job/offline/" + jid;
            $.ajax({
                type:'POST',
                url:url,
                dataType:'json',
                data:{
                },
                success:function(data){
                    if(data.status == '10000'){
                        //alert('POST success');
                        location.reload();
                    }
                    else{
                        alert('POST error\n' + data.status);
                    }

                }
            });
        })
        //重新上线
        $('.button-online').click(function(){
            var jid = $('.ib-operation.active').closest('tr').attr('data-jid');
            var deadline = $('.ib-operation.active').closest('tr').attr('data-deadline');
            $.ajax({
                type:'POST',
                url:"/job/online/"+jid,
                dataType:'json',
                data:{
                    option:{
                        deadline:deadline<(+new Date)?(+new Date + 30*24*60*60*1000):deadline
                    }
                },
                success:function(data){
                    if(data.status == '10000'){
                        //alert('POST success');
                        location.reload();
                    }
                    else{
                        alert('POST error\n' + data.status);
                    }

                }
            });
        })
        $('.button-recommend').click(function(){
            var jid = $('.ib-operation.active').closest('tr').attr('data-jid');
            url = '/job/recommend/' + jid;
            $.ajax({
                type:'POST',
                url:url,
                dataType:'json',
                data:{
                        jid:jid,
                        recommend_id:1
                },
                success:function(data){
                    if(data.status == '10000'){
                        //alert('POST success');
                        location.reload();
                    }
                    else{
                        alert('POST error\n' + data.status);
                    }
                }
            });
        })
/*        //职位下线
        $('.button-logoff').click(function(){
            url = '/job/offline/' + jid;
            $.ajax({
                type:'POST',
                url:url,
                dataType:'json',
                success:function(data){
                    if(data.status == '10000'){
                        //alert('POST success');
                        location.reload();
                    }
                    else{
                        alert('POST error\n' + data.status);
                    }
                }
            });
        })*/
        $('.button-unrecommend').click(function(){
            var jid = $('.ib-operation.active').closest('tr').attr('data-jid');
            url='/job/recommend_cancel/' + jid;
            $.ajax({
                type:'POST',
                url:url,
                dataType:'json',
                data:{
                    id:jid
                },
                success:function(data){
                    if(data.status == '10000'){
                        //alert('POST success');
                        location.reload();
                    }
                    else{
                        alert('POST error\n' + data.status);
                    }
                }
            });
        })
        $('.button-refresh').click(function(){
            var jid = $('.ib-operation.active').closest('tr').attr('data-jid');
            url='/job/refresh/' + jid;
            $.ajax({
                type:'POST',
                url:url,
                dataType:'json',
                data:{
                    id:jid
                },
                success:function(data){
                    if(data.status == '10000'){
                        //alert('POST success');
                        location.reload();
                    }
                    else if(data.status == '10013'){
                        alert('24小时内刷新过不能再刷新');
                    }
                    else if(data.status == '10006'){
                        alert('该职位不存在');
                    }
                    else{
                        alert('POST error\n' + data.status);
                    }
                }
            });
    })
</script>
</body>
</html>